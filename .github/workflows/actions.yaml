name: Build and Push Image

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Enter the new version'
        required: false

jobs:
  build-and-push:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set version
        id: set-version
        run: |
          if [[ -z "${{ github.event.inputs.version }}" ]]; then
            read -p "Enter the new version: " VERSION
            echo "::set-output name=new_version::$VERSION"
          else
            echo "::set-output name=new_version::${{ github.event.inputs.version }}"
          fi

      - name: Build and push Docker image
        run: |
          NEW_VERSION=${{ steps.set-version.outputs.new_version }}
          kp image create tomcat-demo-${NEW_VERSION} \
            --namespace default \
            --builder my-builder \
            --tag dshep15/tomcat-demo:${NEW_VERSION} \
            --git https://github.com/DanielShepelev/tsassignment/ \
            --git-revision main

      - name: Update Helm Chart
        run: |
          NEW_VERSION=${{ steps.set-version.outputs.new_version }}
          sed -i 's#dshep15/tomcat-demo:[0-9].[0-9].[0-9]#dshep15/tomcat-demo:'"$NEW_VERSION"'#g' helmfiles/templates/Deployment.yaml
          cat path/to/Deployment.yaml  # Confirm changes
